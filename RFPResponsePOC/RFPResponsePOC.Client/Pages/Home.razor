@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@page "/"
@using System.Text
@using System.IO.Compression
@using Newtonsoft.Json
@using RFPResponsePOC.Client.Services
@using RFPResponsePOC.Client.Models
@using RFPResponsePOC.Model
@using RFPResponsePOC.Models
@using Radzen.Blazor
@inject AppMetadata _AppMetadata
@inject LogService LogService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject SettingsService _SettingsService
@inject AppMetadata _AppMetadata
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime
<PageTitle>Home</PageTitle>
<RadzenMenu>
    @if (ShowMainMenu)
    {
        <RadzenMenuItem Click="OnHomeClicked" Text="Home" Icon="home" Style="@GetMenuItemStyle("Home")"></RadzenMenuItem>
        <RadzenMenuItem Click="OnKnowledgebaseClicked" Text="Knowledgebase" Icon="library_books" Style="@GetMenuItemStyle("Knowledgebase")"></RadzenMenuItem>
        <RadzenMenuItem Click="OnResponseClicked" Text="Response" Icon="aspect_ratio" Style="@GetMenuItemStyle("Response")"></RadzenMenuItem>
        <RadzenMenuItem Click="OnLogsClicked" Text="Logs" Icon="assignment" Style="@GetMenuItemStyle("Logs")"></RadzenMenuItem>
        <RadzenMenuItem Click="OnSettingsClicked" Text="Settings" Icon="line_style" Style="@GetMenuItemStyle("Settings")"></RadzenMenuItem>
    }
    else
    {
        <RadzenMenuItem Click="OnSettingsClicked" Text="Settings" Icon="line_style" Style="@GetMenuItemStyle("Settings")"></RadzenMenuItem>
    }
</RadzenMenu>
<br />
@if (@InProgress)
{
    <div class="rz-m-10">
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    </div>
}
else
{
    @if (HomeVisible)
    {
        <div class="rz-card step-card">
            <h3 class="text-center">Welcome to RFP Response POC</h3>
            <div class="step-message">
                @if (!KnowledgebaseFileExists)
                {
                    <RadzenButton class="step-button" Text="Build Knowledgebase" Click="@KnowledgebaseClicked" Style="background-color: green;" ButtonStyle="ButtonStyle.Primary" />
                    <br />
                    <br />
                }
                else
                {
                    <RadzenButton class="step-button" Text="Create Response" Click="@ResponseClicked" Style="background-color: green;" ButtonStyle="ButtonStyle.Primary" />
                }
            </div>
        </div>
    }
    @if (ResponseVisible)
    {
        <Response></Response>
    }
    @if (KnowledgebaseVisible)
    {
        <Knowledgebase></Knowledgebase>
    }
    @if (SettingsVisible)
    {
        <Settings SettingsChanged="HandleSettingsChanged"></Settings>
    }
    @if (LogsVisible)
    {
        <Logs></Logs>
    }
}

@code {
#nullable disable
    private IDisposable registration;

    // Allow access to the JSRuntime
    private DotNetObjectReference<Home> objRef;

    string BasePath = @"/RFPResponsePOC";

    bool ShowMainMenu = false;
    string ApiKey = "";
    string AIModel = "";

    bool InProgress = true;
    bool HomeVisible = true;
    bool SettingsVisible = false;
    bool LogsVisible = false;
    bool ResponseVisible = false;
    bool KnowledgebaseVisible = false;
    bool KnowledgebaseFileExists = false;

    // Track active menu item for highlighting
    string ActiveMenuItem = "Home";

    ZipService objZipService = new ZipService();
    bool ZipFileExists = false;

    // Helper method to get inline style for menu items
    private string GetMenuItemStyle(string menuItem)
    {
        return ActiveMenuItem == menuItem 
            ? "background-color: lightgray !important; color: white !important; font-weight: bold !important;"
            : "";
    }

    // Run on page load
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set a reference to the current instance of Home
            objRef = DotNetObjectReference.Create(this);

            // Register the beforeunload event with JavaScript
            await JsRuntime.InvokeVoidAsync("setupBeforeUnload", objRef);

            // Initialize the ZipService with DialogService so dialogs can show
            objZipService = new ZipService(JsRuntime, localStorage, _SettingsService, LogService, DialogService);

            try
            {
                ZipFileExists = await objZipService.IsZipFileExistsAsync();

                if (ZipFileExists)
                {
                    // If it exists, unzip the file
                    await objZipService.UnzipFile();
                }
                else
                {
                    // Create Log file in the virtual directory
                    if (!File.Exists(@"/RFPResponsePOC/RFPResponsePOCLog.csv"))
                    {
                        using (var streamWriter = new StreamWriter(@"/RFPResponsePOC/RFPResponsePOCLog.csv"))
                        {
                            streamWriter.WriteLine("Application started at " + DateTime.Now + " [" + DateTime.Now.Ticks.ToString() + "]");
                        }
                    }

                    // Switch to the Settings page
                    ActiveMenuItem = "Settings";
                    HomeVisible = false;
                    SettingsVisible = true;
                    LogsVisible = false;
                    ResponseVisible = false;
                    KnowledgebaseVisible = false;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }

            InProgress = false;

            // Load Settings
            _SettingsService.LoadSettings();

            ApiKey = _SettingsService.Settings.ApplicationSettings.ApiKey ?? "";
            AIModel = _SettingsService.Settings.ApplicationSettings.AIModel;

            // Check if API Key is entered
            if (ApiKey.Length > 1)
            {
                ShowMainMenu = true;
            }
            else
            {
                ShowMainMenu = false;

                // Switch to the Settings page
                ActiveMenuItem = "Settings";
                HomeVisible = false;
                SettingsVisible = true;
                LogsVisible = false;
                ResponseVisible = false;
                KnowledgebaseVisible = false;
            }

            // Check if there is a Knowledgebase file with data
            if (File.Exists($"{BasePath}//knowledgebase.json"))
            {
                var knowledgebaseContent = await File.ReadAllTextAsync($"{BasePath}//knowledgebase.json");
                if (!string.IsNullOrWhiteSpace(knowledgebaseContent))
                {
                    try
                    {
                        var knowledgebaseData = JsonConvert.DeserializeObject<List<KnowledgeChunk>>(knowledgebaseContent);
                        if (knowledgebaseData != null && knowledgebaseData.Count > 0)
                        {
                            KnowledgebaseFileExists = true;
                        }
                    }
                    catch (System.Text.Json.JsonException)
                    {
                        KnowledgebaseFileExists = false;
                    }
                }
            }

            StateHasChanged();
        }
    }

    // Events

    void OnHomeClicked(MenuItemEventArgs args)
    {
        ActiveMenuItem = "Home";
        HomeVisible = true;
        SettingsVisible = false;
        ResponseVisible = false;
        LogsVisible = false;
        KnowledgebaseVisible = false;
    }

    void OnSettingsClicked(MenuItemEventArgs args)
    {
        ActiveMenuItem = "Settings";
        HomeVisible = false;
        SettingsVisible = true;
        ResponseVisible = false;
        LogsVisible = false;
        KnowledgebaseVisible = false;
    }

    void OnLogsClicked(MenuItemEventArgs args)
    {
        ActiveMenuItem = "Logs";
        HomeVisible = false;
        SettingsVisible = false;
        ResponseVisible = false;
        LogsVisible = true;
        KnowledgebaseVisible = false;
    }

    void OnResponseClicked(MenuItemEventArgs args)
    {
        ActiveMenuItem = "Response";
        HomeVisible = false;
        SettingsVisible = false;
        ResponseVisible = true;
        LogsVisible = false;
        KnowledgebaseVisible = false;
    }

    void OnKnowledgebaseClicked(MenuItemEventArgs args)
    {
        ActiveMenuItem = "Knowledgebase";
        HomeVisible = false;
        SettingsVisible = false;
        ResponseVisible = false;
        LogsVisible = false;
        KnowledgebaseVisible = true;
    }

    void KnowledgebaseClicked(MouseEventArgs args)
    {
        ActiveMenuItem = "Knowledgebase";
        HomeVisible = false;
        SettingsVisible = false;
        ResponseVisible = false;
        LogsVisible = false;
        KnowledgebaseVisible = true;
    }

    void ResponseClicked(MouseEventArgs args)
    {
        ActiveMenuItem = "Response";
        HomeVisible = false;
        SettingsVisible = false;
        ResponseVisible = true;
        LogsVisible = false;
        KnowledgebaseVisible = false;
    }

    private void HandleSettingsChanged()
    {
        _SettingsService.LoadSettings();

        ApiKey = _SettingsService.Settings.ApplicationSettings.ApiKey;
        AIModel = _SettingsService.Settings.ApplicationSettings.AIModel;

        ActiveMenuItem = "Home";
        HomeVisible = true;
        SettingsVisible = false;
        ResponseVisible = false;
        LogsVisible = false;
        KnowledgebaseVisible = false;

        ShowMainMenu = true;
        ZipFileExists = true;

        StateHasChanged();
    }

    // JavaScript Events

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            registration =
                Navigation.RegisterLocationChangingHandler(OnLocationChanging);
        }
    }

    #region JavaScript
    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        // Get the base URL
        string baseUrl = Navigation.BaseUri;

        // Detect that user is going to counter page
        if (context.TargetLocation != baseUrl)
        {
            // User is navigating away from the page - Zip any files
            // Zip up any files and store in LocalStorage
            Task.Run(async () => await objZipService.ZipTheFiles());
        }

        return ValueTask.CompletedTask;
    }

    [JSInvokable]
    public async Task HandleBeforeUnload()
    {
        // User is navigating away from the page - Zip any files
        // Zip up any files and store in LocalStorage
        await objZipService.ZipTheFiles();
    }
    #endregion

    #region private int ConvertToInteger(string strParamVersion)
    private int ConvertToInteger(string strParamVersion)
    {
        int intVersionNumber = 0;
        string strVersion = strParamVersion;

        // Split into parts separated by periods
        char[] splitchar = { '.' };
        var strSegments = strVersion.Split(splitchar);

        // Process the segments
        int i = 0;
        List<int> colMultipliers = new List<int> { 10000, 100, 1 };
        foreach (var strSegment in strSegments)
        {
            int intSegmentNumber = Convert.ToInt32(strSegment);
            intVersionNumber = intVersionNumber + (intSegmentNumber * colMultipliers[i]);
            i++;
        }

        return intVersionNumber;
    }
    #endregion

    public void Dispose()
    {
        // Remove the beforeunload callback when component is disposed
        if (objRef != null)
        {
            try
            {
                JsRuntime.InvokeVoidAsync("removeBeforeUnloadCallback", objRef);
            }
            catch (Exception)
            {
                // Ignore errors during disposal
            }
            objRef?.Dispose();
        }
        
        registration?.Dispose();
    }
}