@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using System.Text
@using System.Collections.Generic
@using System.Linq
@using BlazorWebAssemblyPDF.Services
@using RFPResponsePOC.Client.Models
@using RFPResponsePOC.Client.Services
@using System.IO
@using RFPResponsePOC.Model
@using RFPResponsePOC.Models
@using Newtonsoft.Json
@using Microsoft.AspNetCore.Components.Forms
@using RFPResponsePOC.AI
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject LogService LogService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject SettingsService _SettingsService
@inject NavigationManager Navigation
@inject PdfToPngService PdfService
@inject IJSRuntime JsRuntime
@inject HttpClient Http
<h3>Capacity</h3>
<br />
<RadzenUpload @ref="uploader"
              ChooseText="Upload capacity chart (.pdf/.png/.jpg/.jpeg)" Accept=".png,.jpg,.jpeg,.pdf"
              Change=@OnCapacityChartUpload
              Multiple="false"
              Auto="true"
              Style="width: 100%"
              InputAttributes="@(new Dictionary<string,object>{ { "aria-label", "select file" }})">
</RadzenUpload>
<br />
@if (@InProgress)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center;">
        <div class="rz-card" style="padding: 20px;">
            <RadzenText Text="@CurrentStatus" class="rz-m-10" Style="text-align: center" />
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        </div>
    </div>
}
<br />
@if (capacityData?.Rooms != null)
{
    <RadzenButton Text="Add Room" Icon="add" Style="margin-bottom: 10px; background-color: green;" ButtonStyle="ButtonStyle.Primary" Click="OpenAddRoomDialog" />
    @if (ParentRooms.Count() >= 1)
    {
        <RadzenButton Text="Print Chart" Icon="picture_as_pdf" Style="margin-left: 10px; margin-bottom: 10px;" ButtonStyle="ButtonStyle.Secondary" Click="PrintCapacityChart" />
    }
    <RadzenDataGrid id="capacityGrid" @ref="grid" Data="@ParentRooms" TItem="Room" EditMode="DataGridEditMode.Single" AllowPaging="false" AllowColumnResize="true" ExpandMode="DataGridExpandMode.Single" RowRender="@RowRender" RowExpand="@LoadChildRooms">
        <Template Context="group">
            <RadzenDataGrid Data="@GetChildRooms(group)" TItem="Room" AllowPaging="false" AllowColumnResize="true">
                <Columns>
                    <RadzenDataGridColumn TItem="Room" Title="Edit" Context="r" Resizable="false" Width="50px">
                        <Template Context="r">
                            <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(async () => await OpenEditDialog(r))" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="Room" Property="Name" Title="Name" Resizable="true" Width="200px" Sortable="true" />
                    <RadzenDataGridColumn TItem="Room" Title="Details" Resizable="true">
                        <Template Context="r">
                            <div style="white-space: pre-wrap;">Square Feet: <b>@($"{r.SquareFeet ?? 0}")</b> Length: <b>@($"{r.Length ?? 0}")</b> Width: <b>@($"{r.Width ?? 0}")</b> Ceiling Height: <b>@($"{r.CeilingHeight ?? 0}")</b> Floor Level: <b>@($"{r.FloorLevel ?? "0"}")</b> Natural Light: <b>@($"{(r.HasNaturalLight == true ? "Yes" : "No")}")</b> Has Pillars: <b>@($"{(r.HasPillars == true ? "Yes" : "No")}")</b><br /><br />
                            </div>
                            <div style="white-space: pre-wrap;">Banquet: <b>@($"{r.Capacities.Banquet ?? 0}")</b> Conference: <b>@($"{r.Capacities.Conference ?? 0}")</b> Square: <b>@($"{r.Capacities.Square ?? 0}")</b> Reception: <b>@($"{r.Capacities.Reception ?? 0}")</b> School Room: <b>@($"{r.Capacities.SchoolRoom ?? 0}")</b> Theatre: <b>@($"{r.Capacities.Theatre ?? 0}")</b> U-Shape: <b>@($"{r.Capacities.UShape ?? 0}")</b> Hollow Square: <b>@($"{r.Capacities.HollowSquare ?? 0}")</b> Boardroom: <b>@($"{r.Capacities.Boardroom ?? 0}")</b> Crescent Rounds: <b>@($"{r.Capacities.CrescentRounds ?? 0}")</b>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </Template>
        <Columns>
            <RadzenDataGridColumn TItem="Room" Title="Edit" Context="r" Resizable="false" Width="50px">
                <Template Context="r">
                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(async () => await OpenEditDialog(r))" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Room" Property="Name" Title="Name" Resizable="true" Width="200px" Sortable="true" />
            <RadzenDataGridColumn TItem="Room" Title="Details" Resizable="true">
                <Template Context="r">
                    <div style="white-space: pre-wrap;">Square Feet: <b>@($"{r.SquareFeet ?? 0}")</b> Length: <b>@($"{r.Length ?? 0}")</b> Width: <b>@($"{r.Width ?? 0}")</b> Ceiling Height: <b>@($"{r.CeilingHeight ?? 0}")</b> Floor Level: <b>@($"{r.FloorLevel ?? "0"}")</b> Natural Light: <b>@($"{(r.HasNaturalLight == true ? "Yes" : "No")}")</b> Has Pillars: <b>@($"{(r.HasPillars == true ? "Yes" : "No")}")</b><br /><br />
                    </div>
                    <div style="white-space: pre-wrap;">Banquet: <b>@($"{r.Capacities.Banquet ?? 0}")</b> Conference: <b>@($"{r.Capacities.Conference ?? 0}")</b> Square: <b>@($"{r.Capacities.Square ?? 0}")</b> Reception: <b>@($"{r.Capacities.Reception ?? 0}")</b> School Room: <b>@($"{r.Capacities.SchoolRoom ?? 0}")</b> Theatre: <b>@($"{r.Capacities.Theatre ?? 0}")</b> U-Shape: <b>@($"{r.Capacities.UShape ?? 0}")</b> Hollow Square: <b>@($"{r.Capacities.HollowSquare ?? 0}")</b> Boardroom: <b>@($"{r.Capacities.Boardroom ?? 0}")</b> Crescent Rounds: <b>@($"{r.Capacities.CrescentRounds ?? 0}")</b>
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
}
<!-- hidden canvas used for PDF conversions to PNG -->
<canvas id="pdfCanvas" style="display:none; border:1px solid #ccc;"></canvas>
@code {
#nullable disable
    private IDisposable registration;

    string BasePath = @"/RFPResponsePOC";

    // Allow access to the JSRuntime
    private DotNetObjectReference<Capacity> objRef;

    // Reference to the RadzenUpload component
    Radzen.Blazor.RadzenUpload uploader;
    Radzen.Blazor.RadzenDataGrid<Room> grid;

    AIResponse result = new AIResponse();

    CapacityRoot capacityData;

    ZipService objZipService = new ZipService();

    Dictionary<string, IEnumerable<Room>> childRooms = new();

    IEnumerable<Room> ParentRooms => capacityData?.Rooms?.Where(r => string.IsNullOrEmpty(r.RoomGroup)) ?? Enumerable.Empty<Room>();

    IEnumerable<Room> GetChildRooms(Room group) => childRooms.TryGetValue(group.Name, out var rooms) ? rooms : Enumerable.Empty<Room>();

    void RowRender(RowRenderEventArgs<Room> args)
    {
        args.Expandable = capacityData?.Rooms?.Any(r => r.RoomGroup == args.Data.Name) == true;
    }

    void LoadChildRooms(Room room)
    {
        childRooms[room.Name] = capacityData?.Rooms?.Where(r => r.RoomGroup == room.Name).ToList();
    }

    private async Task PrintCapacityChart()
    {
        await JsRuntime.InvokeVoidAsync("pdfInterop.exportRoomsToPdf", capacityData?.Rooms);
    }

    private bool InProgress = false;
    private string CurrentStatus = "";

    // Run on page load
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set a reference to the current instance of Home
            objRef = DotNetObjectReference.Create(this);

            // Register the beforeunload event with JavaScript
            await JsRuntime.InvokeVoidAsync("setupBeforeUnload", objRef);

            // Register the location changing handler
            registration =
            Navigation.RegisterLocationChangingHandler(OnLocationChanging);

            // Initialize the ZipService
            objZipService = new ZipService(JsRuntime, localStorage, _SettingsService, LogService);

            // Check if Capacity.json exists and load it
            var capacityJson = await GetCapacityJsonAsync();

            if (!string.IsNullOrEmpty(capacityJson))
            {
                capacityData = JsonConvert.DeserializeObject<CapacityRoot>(capacityJson);
                StateHasChanged();
            }
        }
    }

    #region JavaScript
    private ValueTask OnLocationChanging(LocationChangingContext context)
    {
        // Get the base URL
        string baseUrl = Navigation.BaseUri;

        // Detect that user is going to counter page
        if (context.TargetLocation != baseUrl)
        {
            // User is navigating away from the page - Zip any files
            // Zip up any files and store in LocalStorage
            Task.Run(async () => await objZipService.ZipTheFiles());
        }

        return ValueTask.CompletedTask;
    }

    [JSInvokable]
    public async Task HandleBeforeUnload()
    {
        // User is navigating away from the page - Zip any files
        // Zip up any files and store in LocalStorage
        await objZipService.ZipTheFiles();
    }
    #endregion

    private async Task OnCapacityChartUpload(UploadChangeEventArgs e)
    {
        try
        {
            InProgress = true;
            CurrentStatus = "Reading capacity chart...";
            StateHasChanged();

            var file = e.Files.FirstOrDefault();

            if (file is null)
            {
                InProgress = false;
                StateHasChanged();
                return;
            }

            byte[] pdfBytes;

            // If file type is PDF convert it to PNG first
            if (file.ContentType == "application/pdf")
            {
                var pdfUrl = await PdfService.GetPdfDataUrlAsync(file);
                if (pdfUrl != null)
                {
                    await PdfService.RenderPdfToCanvasAsync(pdfUrl, "pdfCanvas");
                    pdfBytes = await PdfService.GetCanvasPngBytesAsync("pdfCanvas");
                }
                else
                {
                    InProgress = false;
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                // Read the file as a byte array
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB limit
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                pdfBytes = ms.ToArray();
            }

            // Read the contents of \Prompts\Capacity.prompt into prompt
            var OCRprompt = await Http.GetStringAsync("Prompts/OCR.prompt");

            // Instantiate orchestrator and settings
            var objOrchestratorMethods = new OrchestratorMethods(_SettingsService, LogService);
            var settingsService = new SettingsService();

            // Call the OpenAIFileAsync method with the settings, prompt, and PDF bytes
            result = await objOrchestratorMethods.CallOpenAIFileAsync(settingsService, OCRprompt, pdfBytes);

            // Process the OCR result

            CurrentStatus = "Converting capacity chart...";
            StateHasChanged();

            // Read the contents of \Prompts\Capacity.prompt into prompt
            var Capcityprompt = await Http.GetStringAsync("Prompts/Capacity.prompt");

            // Replace the placeholder in the prompt with the OCR result
            Capcityprompt = Capcityprompt.Replace("{{OCRResult}}", result.Response);

            // Call the OpenAIChatAsync method with the settings, prompt, and OCR result
            result = await objOrchestratorMethods.CallOpenAIAsync(settingsService, Capcityprompt);

            // Parse the JSON into objects for display
            var TempCapacityData = JsonConvert.DeserializeObject<CapacityRoot>(result.Response);

            // Remove from TempCapacityData any room that has the word "and" or an "&" or a "+" in the room name
            // and build capacityData

            CurrentStatus = "Processing capacity chart...";
            StateHasChanged();

            capacityData = new CapacityRoot
            {
                Rooms = TempCapacityData.Rooms
                    .Where(r => !r.Name.Contains(" and ", StringComparison.OrdinalIgnoreCase) &&
                                !r.Name.Contains("&", StringComparison.OrdinalIgnoreCase) &&
                                !r.Name.Contains("+", StringComparison.OrdinalIgnoreCase))
                    .ToList()
            };

            // Group Rooms by RoomGroup
            capacityData = RoomGroupingHelper.GroupRooms(capacityData.Rooms);

            // Sort by room name
            capacityData.Rooms.Sort((x, y) => string.Compare(x.Name, y.Name, StringComparison.OrdinalIgnoreCase));

            // Serialize the capacityData to JSON
            var json = JsonConvert.SerializeObject(capacityData, Formatting.Indented);

            // Save the JSON result to the virtual file system
            await File.WriteAllTextAsync($"{BasePath}//Capacity.json", json);

            InProgress = false;
            StateHasChanged();

            // Handle result (show notification, update UI, etc.)
            if (result.Error == "")
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Capacity chart uploaded and processed.",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = $"Failed to process the capacity chart. {result.Error}",
                    Duration = 4000
                });
            }

            // Clear the selected files so the list is removed
            await uploader.ClearFiles();
        }
        catch (Exception ex)
        {
            InProgress = false;
            StateHasChanged();

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = ex.Message,
                Duration = 8000
            });
        }
    }

    private Room selectedRoom;

    private async Task OpenEditDialog(Room room)
    {
        selectedRoom = room;

        // Debug: Check if we have rooms data
        Console.WriteLine($"Opening dialog for room: {room?.Name}");
        Console.WriteLine($"Total rooms available: {capacityData?.Rooms?.Count ?? 0}");

        var result = await DialogService.OpenAsync<EditRoomDialog>(
            "Edit Room",
            new Dictionary<string, object> {
                { "Room", selectedRoom },
                { "AllRooms", capacityData?.Rooms ?? new List<Room>() }
            },
            new DialogOptions { Width = "600px", Height = "700px" }
        );

        if (result is EditRoomDialogResult dialogResult)
        {
            if (dialogResult.IsDeleted)
            {
                DeleteRoom(dialogResult.Room);
            }
            else
            {
                SaveRoom(dialogResult.Room);
            }
            await grid.Reload();
            childRooms.Clear();
            StateHasChanged();
        }
    }

    private async Task OpenAddRoomDialog()
    {
        if (capacityData == null)
        {
            capacityData = new CapacityRoot { Rooms = new List<Room>() };
        }

        var newRoom = new Room
        {
            Capacities = new Capacities()
        };

        var result = await DialogService.OpenAsync<EditRoomDialog>(
            "Add Room",
            new Dictionary<string, object>
            {
                { "Room", newRoom },
                { "AllRooms", capacityData?.Rooms ?? new List<Room>() }
            },
            new DialogOptions { Width = "600px", Height = "700px" }
        );

        if (result is EditRoomDialogResult dialogResult && !dialogResult.IsDeleted)
        {
            SaveRoom(dialogResult.Room);
            await grid.Reload();
            childRooms.Clear();
            StateHasChanged();
        }
    }

    private void SaveRoom(Room room)
    {
        // Update the room in the data source
        var index = capacityData.Rooms.FindIndex(r => r.Name == room.Name);

        if (index >= 0)
        {
            capacityData.Rooms[index] = room;
        }
        else
        {
            capacityData.Rooms.Add(room);
        }

        // Save changes to the JSON file
        Task.Run(async () =>
        {
            var json = JsonConvert.SerializeObject(capacityData, Formatting.Indented);
            await File.WriteAllTextAsync($"{BasePath}//Capacity.json", json);
        });
    }

    private void DeleteRoom(Room room)
    {
        // Remove the room from the data source
        var index = capacityData.Rooms.FindIndex(r => r.Name == room.Name);

        if (index >= 0)
        {
            capacityData.Rooms.RemoveAt(index);
        }

        // Save changes to the JSON file
        Task.Run(async () =>
        {
            var json = JsonConvert.SerializeObject(capacityData, Formatting.Indented);
            await File.WriteAllTextAsync($"{BasePath}//Capacity.json", json);
        });
    }

    private async Task<string> GetCapacityJsonAsync()
    {
        try
        {
            if (File.Exists($"{BasePath}//Capacity.json"))
            {
                return await File.ReadAllTextAsync($"{BasePath}//Capacity.json");
            }
        }
        catch (Exception ex)
        {
            // Log the exception if necessary
            Console.WriteLine($"Error reading Capacity.json: {ex.Message}");
        }
        return null;
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}